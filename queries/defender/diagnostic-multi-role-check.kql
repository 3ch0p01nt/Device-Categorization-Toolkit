let LookbackDays = 30;
let BaselineDevices = DeviceInfo | where Timestamp > ago(LookbackDays * 1d) | summarize arg_max(Timestamp, *) by DeviceId, DeviceName | extend IsServerOS = OSPlatform has_any ("Server", "WindowsServer");
let AdminWorkstations = DeviceProcessEvents | where Timestamp > ago(LookbackDays * 1d) | where FileName in~ ("dsa.msc", "dnsmgmt.msc", "gpmc.msc", "ServerManager.exe", "PsExec.exe", "PsExec64.exe", "mmc.exe") | summarize AdminToolCount = count() by DeviceId, DeviceName | where AdminToolCount > 20 | join kind=inner (BaselineDevices | where not(IsServerOS) | project DeviceId) on DeviceId | extend Category = "IT Admin Workstation";
let DeveloperWorkstations = DeviceProcessEvents | where Timestamp > ago(LookbackDays * 1d) | where FileName in~ ("devenv.exe", "Code.exe", "rider64.exe", "idea64.exe", "pycharm64.exe", "git.exe", "node.exe", "python.exe", "docker.exe", "dotnet.exe", "npm.exe") | summarize DevToolCount = count() by DeviceId, DeviceName | where DevToolCount > 50 | join kind=inner (BaselineDevices | where not(IsServerOS) | project DeviceId) on DeviceId | extend Category = "Developer Workstation";
let SecurityWorkstations = DeviceProcessEvents | where Timestamp > ago(LookbackDays * 1d) | where FileName in~ ("Wireshark.exe", "procmon.exe", "procexp.exe", "autoruns.exe", "tcpview.exe", "Fiddler.exe", "nmap.exe") | summarize SecToolCount = count() by DeviceId, DeviceName | where SecToolCount > 10 | join kind=inner (BaselineDevices | where not(IsServerOS) | project DeviceId) on DeviceId | extend Category = "Security Analyst Workstation";
union AdminWorkstations, DeveloperWorkstations, SecurityWorkstations | summarize Categories = make_set(Category), RoleCount = dcount(Category) by DeviceId, DeviceName | where RoleCount > 1 | order by RoleCount desc
